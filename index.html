<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TradePilot Terminal — Stocks (Paper + Broker Assist)</title>
<style>
:root{
  --bg:#0a0f1f; --card:#141a36; --card2:#101632;
  --txt:#eef2ff; --mut:#aab4e6; --line:rgba(255,255,255,.10);
  --a:#4cf2c2; --b:#5b7cff; --good:#49ffb0; --bad:#ff6b6b; --warn:#ffd36b;
  --shadow:0 18px 60px rgba(0,0,0,.55);
  --r:18px;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
}
*{box-sizing:border-box}
body{
  margin:0; color:var(--txt); font-family:var(--sans);
  background:
    radial-gradient(900px 520px at 14% 10%, rgba(76,242,194,.22), transparent 60%),
    radial-gradient(900px 520px at 86% 10%, rgba(91,124,255,.22), transparent 60%),
    var(--bg);
}
.wrap{max-width:1180px;margin:0 auto;padding:22px 14px 60px}
.top{
  display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
  border:1px solid var(--line); border-radius:var(--r);
  background:rgba(20,26,54,.78); backdrop-filter:blur(10px); box-shadow:var(--shadow);
  padding:14px 14px;
}
.brand{display:flex;gap:12px;align-items:center}
.logo{
  width:44px;height:44px;border-radius:16px;
  background:linear-gradient(135deg, rgba(76,242,194,.95), rgba(91,124,255,.90));
  box-shadow:0 16px 26px rgba(76,242,194,.12);
  position:relative; overflow:hidden;
}
.logo:after{content:"";position:absolute;inset:-30%;
  background:radial-gradient(circle at 25% 30%, rgba(255,255,255,.55), transparent 44%);
  transform:rotate(18deg);
}
.brand h1{margin:0;font-size:16px;letter-spacing:.2px}
.brand p{margin:0;color:var(--mut);font-size:12px}
.actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
button, .btn{
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  color:var(--txt);
  padding:10px 12px;
  border-radius:14px;
  cursor:pointer;
  font-weight:750;
  transition:.2s transform,.2s background;
}
button:hover{transform:translateY(-1px); background:rgba(255,255,255,.09)}
button.primary{
  border-color:rgba(76,242,194,.35);
  background:linear-gradient(135deg, rgba(76,242,194,.22), rgba(91,124,255,.12));
}
button.danger{border-color:rgba(255,107,107,.35); background:rgba(255,107,107,.10)}
button:disabled{opacity:.55;cursor:not-allowed;transform:none}
.grid{display:grid;grid-template-columns:1.15fr .85fr;gap:14px;margin-top:14px}
@media(max-width:980px){.grid{grid-template-columns:1fr}}
.card{
  border:1px solid var(--line);
  background:rgba(20,26,54,.72);
  border-radius:var(--r);
  box-shadow:var(--shadow);
  padding:16px;
}
h2{margin:0 0 8px;font-size:14px;letter-spacing:.2px}
.sub{margin:0 0 12px;color:var(--mut);font-size:12px}
.two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:560px){.two{grid-template-columns:1fr}}
label{display:block;color:var(--mut);font-size:12px;margin:0 0 6px}
input, select, textarea{
  width:100%;
  padding:11px 12px;
  border-radius:14px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.05);
  color:var(--txt);
  outline:none;
  font-size:14px;
}
textarea{min-height:96px;resize:vertical}
.pills{display:flex;gap:10px;flex-wrap:wrap}
.pill{
  display:inline-flex;gap:8px;align-items:center;
  padding:8px 10px;border-radius:999px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.05);
  font-size:12px;
}
.pill strong{font-family:var(--mono)}
.div{height:1px;background:var(--line);margin:14px 0}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
@media(max-width:980px){.kpis{grid-template-columns:repeat(2,1fr)}}
.kpi{border:1px solid var(--line);background:rgba(255,255,255,.05);border-radius:16px;padding:12px}
.kpi .t{font-size:11px;color:var(--mut);margin-bottom:6px}
.kpi .v{font-size:16px;font-weight:900;font-family:var(--mono)}
.tag{display:inline-flex;align-items:center;gap:6px;padding:7px 10px;border-radius:999px;border:1px solid var(--line);font-weight:850;font-size:12px}
.tag.good{border-color:rgba(73,255,176,.35);color:var(--good)}
.tag.bad{border-color:rgba(255,107,107,.35);color:var(--bad)}
.tag.warn{border-color:rgba(255,211,107,.35);color:var(--warn)}
.log{max-height:260px;overflow:auto;border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.03)}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top}
th{position:sticky;top:0;background:rgba(20,26,54,.95);text-align:left}
td{color:rgba(255,255,255,.88)}
.mono{font-family:var(--mono)}
.noteBox{display:grid;gap:10px}
.small{font-size:12px;color:var(--mut)}
.modalBack{position:fixed;inset:0;background:rgba(0,0,0,.58);display:flex;align-items:center;justify-content:center;padding:14px;z-index:50}
.modal{width:min(560px,100%);border:1px solid var(--line);background:rgba(20,26,54,.96);border-radius:18px;box-shadow:var(--shadow);padding:16px}
.hidden{display:none !important}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>TradePilot Terminal</h1>
        <p>Stocks • Paper trading + Broker-Assist sessions • Owner analytics + notes</p>
      </div>
    </div>
    <div class="actions">
      <button class="primary" id="btnLogin">Owner Login</button>
      <button id="btnReset" class="danger">Reset</button>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <h2>Trade Control</h2>
      <p class="sub">
        This page can’t place Robinhood/Fidelity orders directly (no official public APIs). It supports:
        <b>Paper Automation</b> and <b>Broker-Assist Automation</b> (opens the broker trade page when the bot decides).
      </p>

      <div class="two">
        <div>
          <label>Ticker</label>
          <input id="ticker" value="AAPL" placeholder="AAPL"/>
        </div>
        <div>
          <label>Broker Assist Mode</label>
          <select id="broker">
            <option value="none">Paper Only</option>
            <option value="robinhood">Robinhood Assist</option>
            <option value="fidelity">Fidelity Assist</option>
          </select>
        </div>
      </div>

      <div class="two" style="margin-top:10px;">
        <div>
          <label>Starting Balance ($)</label>
          <input id="startBal" type="number" value="10" min="0" step="0.01"/>
        </div>
        <div>
          <label>Amount per trade ($)</label>
          <input id="tradeAmt" type="number" value="2" min="0.01" step="0.01"/>
        </div>
      </div>

      <div class="two" style="margin-top:10px;">
        <div>
          <label>Profit goal ($)</label>
          <input id="profitGoal" type="number" value="1" min="0" step="0.01"/>
        </div>
        <div>
          <label>Time horizon (minutes)</label>
          <input id="minutes" type="number" value="15" min="1" step="1"/>
        </div>
      </div>

      <div class="two" style="margin-top:10px;">
        <div>
          <label>Bot speed (seconds)</label>
          <select id="speed">
            <option value="10">10s</option>
            <option value="15" selected>15s</option>
            <option value="30">30s</option>
            <option value="60">60s</option>
          </select>
        </div>
        <div>
          <label>Exit at</label>
          <select id="exitRule">
            <option value="tp1" selected>+1.0% take-profit</option>
            <option value="tp05">+0.5% take-profit</option>
            <option value="tp15">+1.5% take-profit</option>
            <option value="trend">Trend flip exit</option>
          </select>
        </div>
      </div>

      <div class="div"></div>

      <div class="pills">
        <span class="pill">Price: <strong id="price">$—</strong></span>
        <span class="pill">Signal Score: <strong id="score">—</strong></span>
        <span class="pill">Trend: <strong id="trend">—</strong></span>
        <span class="pill">Session: <strong id="sessionLeft">—</strong></span>
        <span id="sigTag" class="tag warn">IDLE</span>
      </div>

      <div class="kpis">
        <div class="kpi"><div class="t">Cash</div><div class="v" id="cash">$—</div></div>
        <div class="kpi"><div class="t">Shares</div><div class="v" id="shares">0.000000</div></div>
        <div class="kpi"><div class="t">Equity</div><div class="v" id="equity">$—</div></div>
        <div class="kpi"><div class="t">P/L</div><div class="v" id="pl">$—</div></div>
      </div>

      <div class="div"></div>

      <div class="pills">
        <button class="primary" id="btnStart">Start Session</button>
        <button id="btnStop" disabled>Stop</button>
        <button id="btnBuy" disabled>Manual Buy</button>
        <button id="btnSell" disabled>Manual Sell</button>
        <button id="btnExport">Export Trades</button>
      </div>

      <p class="small">
        If Broker Assist is enabled, BUY/SELL decisions will open the broker page in a new tab for quick confirmation.
      </p>

      <div class="div"></div>

      <h2>Trade Log</h2>
      <div class="log">
        <table>
          <thead>
            <tr>
              <th>Time</th><th>Action</th><th>Price</th><th>Qty</th><th>P/L</th><th>Note</th>
            </tr>
          </thead>
          <tbody id="logBody"></tbody>
        </table>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <h2>Owner Analytics + Notes</h2>
      <p class="sub">Login unlocks owner tools. Notes are timestamped and downloadable.</p>

      <div class="two">
        <div class="kpi">
          <div class="t">Trades</div>
          <div class="v" id="aTrades">0</div>
        </div>
        <div class="kpi">
          <div class="t">Wins / Losses</div>
          <div class="v" id="aWL">0 / 0</div>
        </div>
      </div>

      <div class="two" style="margin-top:10px;">
        <div class="kpi">
          <div class="t">Best Trade</div>
          <div class="v" id="aBest">$0.00</div>
        </div>
        <div class="kpi">
          <div class="t">Worst Trade</div>
          <div class="v" id="aWorst">$0.00</div>
        </div>
      </div>

      <div class="div"></div>

      <div class="noteBox">
        <div>
          <label>Add Note (timestamped)</label>
          <textarea id="noteText" placeholder="Write your owner note here…"></textarea>
        </div>
        <div class="two">
          <button id="btnAddNote" class="primary" disabled>Add Note</button>
          <button id="btnDownloadNotes" disabled>Download Notes</button>
        </div>
        <div class="log" style="max-height:210px">
          <table>
            <thead><tr><th>Time</th><th>Note</th></tr></thead>
            <tbody id="notesBody"></tbody>
          </table>
        </div>
        <p class="small">
          Owner login: <span class="mono">owner / owner</span>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- LOGIN MODAL -->
<div id="loginModal" class="modalBack hidden" role="dialog" aria-modal="true">
  <div class="modal">
    <h2 style="margin:0 0 6px;">Owner Login</h2>
    <p class="sub">Local demo login. Unlocks owner analytics, notes, and trading controls.</p>
    <div class="two">
      <div>
        <label>Username</label>
        <input id="u" placeholder="owner"/>
      </div>
      <div>
        <label>Password</label>
        <input id="p" type="password" placeholder="owner"/>
      </div>
    </div>
    <div class="div"></div>
    <div class="pills">
      <button class="primary" id="doLogin">Login</button>
      <button id="closeLogin">Cancel</button>
    </div>
    <p class="small">Demo creds: <span class="mono">owner / owner</span></p>
  </div>
</div>

<script>
/* ===============================
   TradePilot Terminal (single file)
   - Live quotes via Stooq CSV (free)
   - Paper trading portfolio
   - Broker-assist sessions for RH/Fidelity
   - Owner analytics + timestamped notes + downloads
================================ */

const $ = (id)=>document.getElementById(id);
const money = (n)=>"$"+(Number.isFinite(n)?n.toFixed(2):"—");
const fmt = (n,d=6)=> (Number.isFinite(n)?n.toFixed(d):"—");
const nowISO = ()=> new Date().toISOString().replace("T"," ").slice(0,19);

const LS="tradepilot_terminal_v1";
const state = loadState();

let timer=null;
let sessionEndsAt=0;
let lastPrice=null;
let priceWindow=[]; // last N prices for trend calc

function defaultState(){
  return {
    owner:false,
    portfolio:{ cash:10, qty:0, avgEntry:0, realized:0 },
    trades:[],
    notes:[]
  };
}
function loadState(){
  try{
    const raw = localStorage.getItem(LS);
    if(!raw) return defaultState();
    const s = JSON.parse(raw);
    if(!s.portfolio || !Array.isArray(s.trades) || !Array.isArray(s.notes)) return defaultState();
    return s;
  }catch{ return defaultState(); }
}
function save(){ localStorage.setItem(LS, JSON.stringify(state)); }

function setTag(kind, text){
  const el=$("sigTag");
  el.className="tag "+(kind||"warn");
  el.textContent=text;
}

function toast(msg){
  const t=document.createElement("div");
  t.textContent=msg;
  t.style.position="fixed";
  t.style.bottom="16px";
  t.style.left="50%";
  t.style.transform="translateX(-50%)";
  t.style.background="rgba(20,26,54,.95)";
  t.style.border="1px solid rgba(255,255,255,.12)";
  t.style.padding="10px 12px";
  t.style.borderRadius="14px";
  t.style.boxShadow="0 18px 60px rgba(0,0,0,.55)";
  t.style.zIndex="999";
  document.body.appendChild(t);
  setTimeout(()=>{t.style.opacity="0";t.style.transition="opacity .25s";}, 1400);
  setTimeout(()=>t.remove(), 1750);
}

async function fetchPrice(ticker){
  // Stooq uses tickers like AAPL.US. We'll try US suffix if not present.
  let sym = (ticker||"").trim().toUpperCase();
  if(!sym) return null;
  if(!sym.includes(".")) sym = sym + ".US";
  const url = `https://stooq.com/q/l/?s=${encodeURIComponent(sym.toLowerCase())}&f=sd2t2ohlcv&h&e=csv`;
  const res = await fetch(url);
  if(!res.ok) return null;
  const txt = await res.text();
  const row = txt.split("\n")[1];
  if(!row) return null;
  const parts = row.split(",");
  const close = parseFloat(parts[3]);
  return Number.isFinite(close) ? close : null;
}

function computeTrend(prices){
  // simple: compare last price to SMA
  if(prices.length < 6) return {trend:"—", score:0};
  const sma = prices.reduce((a,b)=>a+b,0) / prices.length;
  const p = prices[prices.length-1];
  const dist = (p - sma) / sma;
  // score: -3..+3
  let score=0;
  if(dist > 0.004) score += 2;
  else if(dist > 0.001) score += 1;
  if(dist < -0.004) score -= 2;
  else if(dist < -0.001) score -= 1;

  // momentum: last 3 moves
  let mom=0;
  for(let i=prices.length-3;i<prices.length;i++){
    if(i<=0) continue;
    const d = prices[i]-prices[i-1];
    mom += d>0 ? 1 : d<0 ? -1 : 0;
  }
  score += mom >= 2 ? 1 : mom <= -2 ? -1 : 0;

  const trend = score>=2 ? "UP" : score<=-2 ? "DOWN" : "SIDE";
  return {trend, score};
}

function equity(price){
  return state.portfolio.cash + state.portfolio.qty * (price||0);
}

function render(){
  $("cash").textContent = money(state.portfolio.cash);
  $("shares").textContent = fmt(state.portfolio.qty, 6);
  $("equity").textContent = money(equity(lastPrice));
  $("pl").textContent = money(equity(lastPrice) - state.startCash);

  $("btnBuy").disabled = !state.owner;
  $("btnSell").disabled = !state.owner;
  $("btnStart").disabled = !state.owner || !!timer;
  $("btnStop").disabled = !state.owner || !timer;

  $("btnAddNote").disabled = !state.owner;
  $("btnDownloadNotes").disabled = !state.owner;

  renderTrades();
  renderNotes();
  renderAnalytics();
}

function renderTrades(){
  const tb=$("logBody");
  tb.innerHTML="";
  const rows=[...state.trades].slice().reverse();
  for(const r of rows){
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${escapeHtml(r.time)}</td>
      <td><span class="tag ${r.action==="BUY"?"good":r.action==="SELL"?"bad":"warn"}">${escapeHtml(r.action)}</span></td>
      <td class="mono">$${Number(r.price).toFixed(2)}</td>
      <td class="mono">${Number(r.qty).toFixed(6)}</td>
      <td class="mono">${r.pl==null?"—":money(Number(r.pl))}</td>
      <td>${escapeHtml(r.note||"")}</td>
    `;
    tb.appendChild(tr);
  }
}

function renderNotes(){
  const tb=$("notesBody");
  tb.innerHTML="";
  const rows=[...state.notes].slice().reverse();
  for(const n of rows){
    const tr=document.createElement("tr");
    tr.innerHTML = `<td class="mono">${escapeHtml(n.time)}</td><td>${escapeHtml(n.text)}</td>`;
    tb.appendChild(tr);
  }
}

function renderAnalytics(){
  const sells = state.trades.filter(t=>t.action==="SELL" && typeof t.pl==="number");
  const wins = sells.filter(s=>s.pl>0).length;
  const losses = sells.filter(s=>s.pl<0).length;
  const best = sells.length ? Math.max(...sells.map(s=>s.pl)) : 0;
  const worst = sells.length ? Math.min(...sells.map(s=>s.pl)) : 0;

  $("aTrades").textContent = String(state.trades.length);
  $("aWL").textContent = `${wins} / ${losses}`;
  $("aBest").textContent = money(best);
  $("aWorst").textContent = money(worst);
}

function logTrade(action, price, qty, pl=null, note=""){
  state.trades.push({time:nowISO(), action, price, qty, pl, note});
  save();
  render();
}

function manualBuy(){
  if(!lastPrice) return toast("No price yet.");
  const amt = Math.max(0.01, parseFloat($("tradeAmt").value||"0"));
  if(state.portfolio.cash < amt) return toast("Not enough cash (paper).");
  const qty = amt / lastPrice;

  const prevVal = state.portfolio.qty * state.portfolio.avgEntry;
  const newVal = prevVal + qty * lastPrice;
  const newQty = state.portfolio.qty + qty;

  state.portfolio.avgEntry = newVal / newQty;
  state.portfolio.qty = newQty;
  state.portfolio.cash -= amt;

  logTrade("BUY", lastPrice, qty, null, "Manual buy");
}

function manualSell(reason="Manual sell"){
  if(!lastPrice) return toast("No price yet.");
  if(state.portfolio.qty <= 1e-9) return toast("No position to sell.");
  const qty = state.portfolio.qty;
  const proceeds = qty * lastPrice;
  const cost = qty * state.portfolio.avgEntry;
  const pl = proceeds - cost;

  state.portfolio.cash += proceeds;
  state.portfolio.qty = 0;
  state.portfolio.avgEntry = 0;
  state.portfolio.realized += pl;

  logTrade("SELL", lastPrice, qty, pl, reason);
}

function exitRuleHit(price){
  if(state.portfolio.qty <= 1e-9) return false;
  const entry = state.portfolio.avgEntry || 0;
  if(!entry) return false;

  const r = $("exitRule").value;
  const change = (price-entry)/entry;

  if(r==="tp05") return change >= 0.005;
  if(r==="tp1") return change >= 0.01;
  if(r==="tp15") return change >= 0.015;
  if(r==="trend"){
    // exit when trend turns DOWN
    const {trend} = computeTrend(priceWindow);
    return trend === "DOWN";
  }
  return false;
}

function brokerAssistOpen(action){
  const broker=$("broker").value;
  const t=$("ticker").value.trim().toUpperCase();
  if(broker==="none") return;

  // These are safe “assist” links (no secret keys). User confirms in broker.
  // Robinhood deep link for stocks works as robinhood.com/stocks/TICKER
  if(broker==="robinhood"){
    window.open(`https://robinhood.com/stocks/${encodeURIComponent(t)}`, "_blank", "noopener,noreferrer");
    toast(`${action}: Opened Robinhood stock page for ${t}`);
  }else if(broker==="fidelity"){
    window.open(`https://digital.fidelity.com/prgw/digital/trade`, "_blank", "noopener,noreferrer");
    toast(`${action}: Opened Fidelity trade ticket (enter ${t})`);
  }
}

function exportTrades(){
  const payload = {
    exportedAt: nowISO(),
    ticker: $("ticker").value.trim().toUpperCase(),
    brokerAssist: $("broker").value,
    session: { startCash: state.startCash, profitGoal: state.profitGoal, minutes: state.minutes },
    portfolio: state.portfolio,
    trades: state.trades
  };
  downloadJSON(payload, "tradepilot-terminal-trades.json");
}

function downloadNotes(){
  const payload = {
    exportedAt: nowISO(),
    notes: state.notes
  };
  downloadJSON(payload, "tradepilot-terminal-notes.json");
}

function downloadJSON(obj, filename){
  const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}

async function tick(){
  const price = await fetchPrice($("ticker").value);
  if(!Number.isFinite(price)) { setTag("warn","NO DATA"); return; }
  lastPrice = price;
  $("price").textContent = "$"+price.toFixed(2);

  priceWindow.push(price);
  if(priceWindow.length > 10) priceWindow.shift();

  const {trend, score} = computeTrend(priceWindow);
  $("trend").textContent = trend;
  $("score").textContent = String(score);

  // session countdown
  const left = Math.max(0, sessionEndsAt - Date.now());
  $("sessionLeft").textContent = timer ? `${Math.ceil(left/1000)}s` : "—";

  // goal/time stop
  const eq = equity(price);
  const profit = eq - state.startCash;

  if(timer){
    if(profit >= state.profitGoal){
      setTag("good","GOAL HIT");
      logTrade("NOTE", price, 0, null, "Profit goal hit — stopping session");
      stopSession();
      return;
    }
    if(Date.now() >= sessionEndsAt){
      setTag("warn","TIME UP");
      logTrade("NOTE", price, 0, null, "Session ended — time up");
      stopSession();
      return;
    }
  }

  // trading decision
  if(!timer){
    setTag("warn","IDLE");
    render();
    return;
  }

  // Entry logic: score >= +2 and enough cash
  const amt = Math.max(0.01, parseFloat($("tradeAmt").value||"0"));
  if(score >= 2 && state.portfolio.cash >= amt){
    // buy paper
    const qty = amt / price;

    const prevVal = state.portfolio.qty * state.portfolio.avgEntry;
    const newVal = prevVal + qty * price;
    const newQty = state.portfolio.qty + qty;

    state.portfolio.avgEntry = newVal / newQty;
    state.portfolio.qty = newQty;
    state.portfolio.cash -= amt;

    logTrade("BUY", price, qty, null, `Auto buy (score ${score})`);
    brokerAssistOpen("BUY");
    save();
  }

  // Exit logic
  if(exitRuleHit(price)){
    manualSell("Auto exit rule hit");
    brokerAssistOpen("SELL");
  }else{
    // Score-based sell when strong downtrend
    if(state.portfolio.qty > 1e-9 && score <= -2){
      manualSell(`Auto sell (score ${score})`);
      brokerAssistOpen("SELL");
    }
  }

  // live tag
  const eq2 = equity(price);
  const profit2 = eq2 - state.startCash;
  setTag(profit2>=0 ? "good" : "bad", "RUNNING");
  render();
}

function startSession(){
  // init portfolio based on inputs
  state.portfolio.cash = Math.max(0, parseFloat($("startBal").value||"0"));
  state.portfolio.qty = 0;
  state.portfolio.avgEntry = 0;
  state.portfolio.realized = 0;

  state.startCash = state.portfolio.cash;
  state.profitGoal = Math.max(0, parseFloat($("profitGoal").value||"0"));
  state.minutes = Math.max(1, parseInt($("minutes").value||"15",10));

  save();

  const speedSec = Math.max(10, parseInt($("speed").value||"15",10));
  sessionEndsAt = Date.now() + state.minutes*60*1000;

  if(timer) clearInterval(timer);
  timer = setInterval(tick, speedSec*1000);

  setTag("good","RUNNING");
  toast(`Session started for ${state.minutes} min • Goal $${state.profitGoal.toFixed(2)} • Every ${speedSec}s`);
  render();
  tick();
}

function stopSession(){
  if(timer) clearInterval(timer);
  timer = null;
  setTag("warn","STOPPED");
  render();
}

function resetAll(){
  if(!confirm("Reset everything (portfolio, trades, notes, login)?")) return;
  localStorage.removeItem(LS);
  location.reload();
}

/* Owner Notes */
function addNote(){
  const txt = ($("noteText").value||"").trim();
  if(!txt) return toast("Write a note first.");
  state.notes.push({time:nowISO(), text:txt});
  $("noteText").value="";
  save();
  render();
  toast("Note saved.");
}

/* Owner Login */
function openLogin(){ $("loginModal").classList.remove("hidden"); }
function closeLogin(){ $("loginModal").classList.add("hidden"); }
function doLogin(){
  const u = ($("u").value||"").trim();
  const p = ($("p").value||"").trim();
  if(u==="owner" && p==="owner"){
    state.owner = true;
    save();
    closeLogin();
    toast("Owner unlocked.");
    render();
  }else toast("Wrong login. Use owner / owner.");
}

/* Wire */
$("btnLogin").addEventListener("click", openLogin);
$("closeLogin").addEventListener("click", closeLogin);
$("doLogin").addEventListener("click", doLogin);

$("btnReset").addEventListener("click", resetAll);
$("btnStart").addEventListener("click", startSession);
$("btnStop").addEventListener("click", stopSession);
$("btnBuy").addEventListener("click", manualBuy);
$("btnSell").addEventListener("click", ()=>manualSell("Manual sell"));
$("btnExport").addEventListener("click", exportTrades);

$("btnAddNote").addEventListener("click", addNote);
$("btnDownloadNotes").addEventListener("click", downloadNotes);

/* Init */
setTag("warn","IDLE");
render();
tick(); // get first quote

</script>
</body>
</html>
